# フォルダとファイル構成の設計

物理粒子シミュレーションアプリケーションのコードを整理し、モジュール性と保守性を高めるために、以下のフォルダとファイル構成を設計します。Rustのモジュールシステムとプロジェクトの拡張性を考慮し、明確な役割分担を持つ構造を採用します。

## 1. プロジェクト全体のディレクトリ構造
```
particle_simulation/
├── src/
│   ├── main.rs                 # エントリーポイントとApp構造体の定義
│   ├── ui.rs                   # UI関連のロジック（入力ペイン、状態管理）
│   ├── render.rs               # 3Dレンダリング関連のロジック（パイプライン、描画）
│   ├── simulation.rs           # 粒子シミュレーションのロジック（物理計算、粒子状態）
│   ├── types.rs                # 共有される型定義（構造体、列挙型）
│   ├── shaders/                # シェーダーファイル
│   │   ├── vertex.glsl         # 頂点シェーダー
│   │   └── fragment.glsl       # フラグメントシェーダー
│   └── tests/                  # テストコード
│       ├── ui_tests.rs         # UI関連のテスト
│       ├── simulation_tests.rs # シミュレーション関連のテスト
│       └── render_tests.rs     # レンダリング関連のテスト
├── Cargo.toml                  # 依存関係とプロジェクト設定
└── README.md                   # プロジェクト概要とビルド手順
```

## 2. 各ファイルの役割と内容

- **`src/main.rs`**:
  - **役割**: アプリケーションのエントリーポイント。`App`構造体と`ApplicationHandler`トレイトの実装を定義。
  - **内容**:
    - `VulkanoContext`、`VulkanoWindows`、`Gui`の初期化。
    - ウィンドウイベント処理（`resumed`、`window_event`、`about_to_wait`）。
    - UIとレンダリングの統合（`ui.rs`と`render.rs`を呼び出し）。
    - サンプルコード（例: `minimal.rs`）を参考に、シンプルなイベントループとGUI統合を実装。
  - **依存モジュール**: `ui`、`render`、`types`。

- **`src/ui.rs`**:
  - **役割**: 右側の入力ペインとUI状態管理のロジック。
  - **内容**:
    - `UiState`構造体の管理（粒子数、重力などの入力値）。
    - `draw_ui`関数: `egui::SidePanel`で入力ペイン、`egui::CentralPanel`で3Dビューエリアを構築。
    - 入力値の更新ロジック（スライダー、テキスト入力、ボタンの処理）。
    - サンプルコード（例: `minimal.rs`の`immediate_ui`）を参考に、UIレイアウトを構築。
  - **依存モジュール**: `egui`、`types`。

- **`src/render.rs`**:
  - **役割**: 3Dレンダリングのセットアップと描画ロジック。
  - **内容**:
    - `setup_render_pipeline`関数: Vulkanoのグラフィックスパイプラインを初期化（頂点/フラグメントシェーダー、フレームバッファ）。
    - `render_scene`関数: 粒子データを頂点バッファに変換し、コマンドバッファに描画コマンドを追加。
    - サンプルコード（例: `subpass.rs`や`paint_callback.rs`）を参考に、サブパスを使用したGUIと3Dの統合。
    - 初期実装では単純な三角形や背景クリアでテスト。
  - **依存モジュール**: `vulkano`、`types`、`shaders`。

- **`src/simulation.rs`**:
  - **役割**: 粒子シミュレーションの物理計算と状態更新。
  - **内容**:
    - `SimulationState`構造体: 粒子データ（位置、速度など）を保持。
    - `update_simulation`関数: 物理計算（例: 重力、衝突）を実行し、粒子状態を更新。
    - 初期実装では空の構造体とダミー関数を用意し、後で拡張。
  - **依存モジュール**: `types`、（将来的に）`nalgebra`や`glam`。

- **`src/types.rs`**:
  - **役割**: プロジェクト全体で共有される型定義。
  - **内容**:
    - `App`構造体: アプリケーションの状態（`context`、`windows`、`gui`、`simulation_state`、`ui_state`）。
    - `UiState`構造体: UI入力値（例: `particle_count: u32`、`gravity: f32`）。
    - `SimulationState`構造体: 粒子データ（例: `Vec<Particle>`）。
    - `Particle`構造体: 単一粒子のデータ（`position: [f32; 3]`、`velocity: [f32; 3]`など）。
  - **依存モジュール**: なし（他のモジュールから参照される）。

- **`src/shaders/vertex.glsl`** と **`src/shaders/fragment.glsl`**:
  - **役割**: 3Dレンダリング用のGLSLシェーダー。
  - **内容**:
    - `vertex.glsl`: 頂点位置と色を処理（サンプルコードの`vs`モジュールを参考）。
    - `fragment.glsl`: フラグメントごとの色出力（サンプルコードの`fs`モジュールを参考）。
    - 初期実装ではサンプルコードのシェーダーをほぼそのまま使用し、粒子描画用に後で調整。
  - **依存**: `vulkano_shaders`マクロでコンパイル。

- **`src/tests/ui_tests.rs`**:
  - **役割**: UI関連のユニットテスト。
  - **内容**:
    - `UiState`の更新ロジックをテスト（例: スライダー入力で値が正しく更新されるか）。
    - モックUIコンテキストを使用して`draw_ui`関数の動作を確認。
  - **依存モジュール**: `ui`、`types`。

- **`src/tests/simulation_tests.rs`**:
  - **役割**: シミュレーション関連のユニットテスト。
  - **内容**:
    - `update_simulation`関数のテスト（例: 重力適用後の粒子位置/速度の変化）。
    - 初期実装ではダミー関数をテストし、後で拡張。
  - **依存モジュール**: `simulation`、`types`。

- **`src/tests/render_tests.rs`**:
  - **役割**: レンダリング関連のユニットテスト。
  - **内容**:
    - `render_scene`関数のテスト（例: 頂点バッファの内容が正しいか）。
    - Vulkanoのモックオブジェクトを使用した簡易テスト。
  - **依存モジュール**: `render`、`types`。

- **`Cargo.toml`**:
  - **役割**: 依存関係とビルド設定。
  - **内容**:
    - バージョンはサンプルコードと最新のクレート状況に合わせる。

- **`README.md`**:
  - **役割**: プロジェクトの概要、ビルド/実行手順、依存関係の説明。
  - **内容**:
    - プロジェクトの目的（物理粒子シミュレーション）。
    - 依存ライブラリのインストール手順。
    - ビルドと実行方法（`cargo run`）。
    - テスト実行方法（`cargo test`）。

## 3. 設計のポイント
- **モジュール性**: 各モジュール（`ui`、`render`、`simulation`）は独立し、相互依存を最小限に抑える。`types.rs`で共有型を定義し、再利用性を確保。
- **拡張性**: 初期実装はシンプル（空のシミュレーション、単純な3Dビュー）だが、粒子データの追加や複雑な物理計算に対応できる構造。
- **テスト容易性**: テストディレクトリを分け、ユニットテストをモジュールごとに整理。モックを利用して依存を軽減。
- **シェーダー管理**: シェーダーを別ファイル（`shaders/`）に分け、`vulkano_shaders`マクロでコンパイル。将来の拡張（例: 粒子エフェクト用のシェーダー）に備える。
